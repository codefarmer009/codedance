# Historical Comments and Reviews

## Discussion Comments

**@codefarmer009** (Oct 24, 04:54)
@xgopilot è¿™ä¸ªé¡¹ç›®éœ€è¦å®ç°ä¸€ä¸ªåŸºäºk8sçš„æ™ºèƒ½å‘å¸ƒç³»ç»Ÿï¼Œéœ€è¦å®ç°ç°åº¦å‘å¸ƒï¼Œå¹¶ä¸”å½“å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜èƒ½å¤Ÿåšåˆ°åŠæ—¶æš‚åœå’Œå›æ»šï¼Œè¯·å¸®æˆ‘æ‹†è§£å…·ä½“éœ€è¦å®ç°çš„ç»†èŠ‚å’Œæ­¥éª¤ï¼ŒåŒ…æ‹¬å…·ä½“çš„æ¶æ„è®¾è®¡ä»¥åŠä»£ç æ¡†æ¶ã€‚

---

**@xgopilot** (Oct 24, 04:55)
### ğŸ¯ åŸºäº Kubernetes çš„æ™ºèƒ½å‘å¸ƒç³»ç»Ÿ - æ¶æ„è®¾è®¡ä¸å®æ–½æ–¹æ¡ˆ

åŸºäºæ‚¨çš„éœ€æ±‚ï¼Œæˆ‘ä¸º codedance é¡¹ç›®è®¾è®¡äº†ä¸€ä¸ªå®Œæ•´çš„ K8s æ™ºèƒ½å‘å¸ƒç³»ç»Ÿï¼Œæ”¯æŒç°åº¦å‘å¸ƒã€å®æ—¶ç›‘æ§ã€è‡ªåŠ¨æš‚åœå’Œå›æ»šåŠŸèƒ½ã€‚

---

## ä¸€ã€ç³»ç»Ÿæ¶æ„è®¾è®¡

### 1.1 æ ¸å¿ƒç»„ä»¶

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‘å¸ƒæ§åˆ¶å¹³é¢                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ å‘å¸ƒæ§åˆ¶å™¨    â”‚  â”‚ ç›‘æ§åˆ†æå™¨    â”‚  â”‚ å†³ç­–å¼•æ“      â”‚      â”‚
â”‚  â”‚ (Controller) â”‚â†’ â”‚ (Analyzer)   â”‚â†’ â”‚ (Decider)    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â†“                 â†‘                  â†“               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ æµé‡ç®¡ç†å™¨    â”‚  â”‚ æŒ‡æ ‡æ”¶é›†å™¨    â”‚  â”‚ å›æ»šç®¡ç†å™¨    â”‚      â”‚
â”‚  â”‚ (Traffic)    â”‚  â”‚ (Metrics)    â”‚  â”‚ (Rollback)   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Kubernetes é›†ç¾¤                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  Stable     â”‚        â”‚  Canary     â”‚                     â”‚
â”‚  â”‚  Pods (v1)  â”‚  â†â†’   â”‚  Pods (v2)  â”‚                     â”‚
â”‚  â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚        â”‚  â–ˆâ–ˆ          â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚         â†‘                       â†‘                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚     Istio / Ingress æµé‡åˆ†å‘         â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚  Prometheus + Grafana ç›‘æ§           â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æŠ€æœ¯æ ˆé€‰æ‹©

| ç»„ä»¶ | æŠ€æœ¯é€‰å‹ | ç”¨é€” |
|------|---------|------|
| ç¼–ç¨‹è¯­è¨€ | Go | é«˜æ€§èƒ½æ§åˆ¶å™¨å¼€å‘ |
| K8s å®¢æˆ·ç«¯ | client-go | Kubernetes API äº¤äº’ |
| æµé‡ç®¡ç† | Istio / Nginx Ingress | ç°åº¦æµé‡æ§åˆ¶ |
| ç›‘æ§ç³»ç»Ÿ | Prometheus + Grafana | æŒ‡æ ‡é‡‡é›†ä¸å¯è§†åŒ– |
| æ—¥å¿—ç³»ç»Ÿ | ELK / Loki | æ—¥å¿—èšåˆåˆ†æ |
| è¿½è¸ªç³»ç»Ÿ | Jaeger | åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ª |
| å­˜å‚¨ | etcd (K8s å†…ç½®) | å‘å¸ƒçŠ¶æ€å­˜å‚¨ |
| API æ¡†æ¶ | Gin / Echo | RESTful API |
| å‰ç«¯ | React + TypeScript | å‘å¸ƒç®¡ç†ç•Œé¢ |

---

## äºŒã€è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

### 2.1 è‡ªå®šä¹‰èµ„æºå®šä¹‰ (CRD)

å®šä¹‰ä¸€ä¸ª `CanaryDeployment` CRD æ¥æè¿°ç°åº¦å‘å¸ƒé…ç½®ï¼š

```yaml
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: canarydeployments.deploy.codedance.io
spec:
  group: deploy.codedance.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              properties:
                targetDeployment:
                  type: string
                  description: "ç›®æ ‡ Deployment åç§°"
                canaryVersion:
                  type: string
                  description: "ç°åº¦ç‰ˆæœ¬é•œåƒ"
                strategy:
                  type: object
                  properties:
                    type:
                      type: string
                      enum: [Linear, Exponential, Manual]
                    steps:
                      type: array
                      items:
                        type: object
                        properties:
                          weight:
                            type: integer
                            minimum: 0
                            maximum: 100
                          pause:
                            type: string
                          metrics:
                            type: array
                            items:
                              type: object
                metrics:
                  type: object
                  properties:
                    successRate:
                      type: object
                      properties:
                        threshold:
                          type: number
                        query:
                          type: string
                    latency:
                      type: object
                      properties:
                        p99:
                          type: number
                        query:
                          type: string
                    errorRate:
                      type: object
                      properties:
                        threshold:
                          type: number
                        query:
                          type: string
                autoRollback:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                    onMetricsFail:
                      type: boolean
                    onPodCrash:
                      type: boolean
```

### 2.2 ç°åº¦å‘å¸ƒç­–ç•¥

#### ç­–ç•¥ 1: çº¿æ€§é€’å¢ï¼ˆLinearï¼‰
```
5% â†’ 10% â†’ 25% â†’ 50% â†’ 75% â†’ 100%
æ¯ä¸ªé˜¶æ®µè§‚å¯Ÿ 5-10 åˆ†é’Ÿ
```

#### ç­–ç•¥ 2: æŒ‡æ•°é€’å¢ï¼ˆExponentialï¼‰
```
1% â†’ 5% â†’ 10% â†’ 25% â†’ 50% â†’ 100%
é€‚åˆé£é™©è¾ƒé«˜çš„å‘å¸ƒ
```

#### ç­–ç•¥ 3: æ‰‹åŠ¨æ§åˆ¶ï¼ˆManualï¼‰
```
ç”¨æˆ·æ‰‹åŠ¨è§¦å‘æ¯ä¸ªé˜¶æ®µçš„æµé‡åˆ‡æ¢
```

### 2.3 ç›‘æ§æŒ‡æ ‡ä½“ç³»

#### å…³é”®æŒ‡æ ‡ï¼ˆKPIsï¼‰

```go
type HealthMetrics struct {
    // è¯·æ±‚æˆåŠŸç‡
    SuccessRate float64 `json:"success_rate"`
    
    // å»¶è¿ŸæŒ‡æ ‡
    Latency struct {
        P50 time.Duration `json:"p50"`
        P90 time.Duration `json:"p90"`
        P99 time.Duration `json:"p99"`
    } `json:"latency"`
    
    // é”™è¯¯ç‡
    ErrorRate float64 `json:"error_rate"`
    
    // Pod å¥åº·çŠ¶æ€
    PodHealth struct {
        Ready    int `json:"ready"`
        NotReady int `json:"not_ready"`
        Failed   int `json:"failed"`
    } `json:"pod_health"`
    
    // èµ„æºä½¿ç”¨
    Resources struct {
        CPUUsage    float64 `json:"cpu_usage"`
        MemoryUsage float64 `json:"memory_usage"`
    } `json:"resources"`
    
    // ä¸šåŠ¡æŒ‡æ ‡
    BusinessMetrics map[string]float64 `json:"business_metrics"`
}
```

#### Prometheus æŸ¥è¯¢ç¤ºä¾‹

```promql
# è¯·æ±‚æˆåŠŸç‡
sum(rate(http_requests_total{status=~"2.."}[5m])) / 
sum(rate(http_requests_total[5m])) * 100

# P99 å»¶è¿Ÿ
histogram_quantile(0.99, 
  sum(rate(http_request_duration_seconds_bucket[5m])) by (le))

# é”™è¯¯ç‡
sum(rate(http_requests_total{status=~"5.."}[5m])) / 
sum(rate(http_requests_total[5m])) * 100
```

### 2.4 å†³ç­–å¼•æ“ç®—æ³•

```go
// ä¼ªä»£ç ï¼šå¥åº·æ£€æŸ¥å†³ç­–
func (d *Decider) EvaluateHealth(metrics HealthMetrics, thresholds Thresholds) Decision {
    score := 0
    maxScore := 100
    
    // 1. æˆåŠŸç‡æ£€æŸ¥ (æƒé‡: 40)
    if metrics.SuccessRate >= thresholds.SuccessRate {
        score += 40
    } else {
        return Decision{
            Action: RollbackAction,
            Reason: fmt.Sprintf("æˆåŠŸç‡ %.2f%% ä½äºé˜ˆå€¼ %.2f%%", 
                   metrics.SuccessRate, thresholds.SuccessRate),
        }
    }
    
    // 2. å»¶è¿Ÿæ£€æŸ¥ (æƒé‡: 30)
    if metrics.Latency.P99 <= thresholds.MaxLatencyP99 {
        score += 30
    } else if metrics.Latency.P99 <= thresholds.MaxLatencyP99*1.2 {
        score += 15 // è½»å¾®è¶…æ ‡ï¼Œé™ä½è¯„åˆ†
    } else {
        return Decision{
            Action: PauseAction,
            Reason: fmt.Sprintf("P99å»¶è¿Ÿ %v è¶…è¿‡é˜ˆå€¼ %v", 
                   metrics.Latency.P99, thresholds.MaxLatencyP99),
        }
    }
    
    // 3. é”™è¯¯ç‡æ£€æŸ¥ (æƒé‡: 30)
    if metrics.ErrorRate <= thresholds.MaxErrorRate {
        score += 30
    } else {
        return Decision{
            Action: RollbackAction,
            Reason: fmt.Sprintf("é”™è¯¯ç‡ %.2f%% è¶…è¿‡é˜ˆå€¼ %.2f%%", 
                   metrics.ErrorRate, thresholds.MaxErrorRate),
        }
    }
    
    // 4. Pod å¥åº·æ£€æŸ¥
    podHealthRate := float64(metrics.PodHealth.Ready) / 
                    float64(metrics.PodHealth.Ready + metrics.PodHealth.NotReady)
    if podHealthRate < 0.8 {
        return Decision{
            Action: PauseAction,
            Reason: fmt.Sprintf("Pod å¥åº·ç‡ %.2f%% è¿‡ä½", podHealthRate*100),
        }
    }
    
    if score >= 90 {
        return Decision{Action: ContinueAction, Score: score}
    } else if score >= 70 {
        return Decision{Action: PauseAction, Score: score, 
                       Reason: "æŒ‡æ ‡è½»å¾®å¼‚å¸¸ï¼Œå»ºè®®æš‚åœè§‚å¯Ÿ"}
    } else {
        return Decision{Action: RollbackAction, Score: score,
                       Reason: "å¤šé¡¹æŒ‡æ ‡å¼‚å¸¸ï¼Œå»ºè®®å›æ»š"}
    }
}
```

### 2.5 æµé‡æ§åˆ¶å®ç°

#### æ–¹æ¡ˆ A: ä½¿ç”¨ Istio VirtualService

```yaml
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: codedance-vs
spec:
  hosts:
    - codedance.example.com
  http:
    - match:
        - headers:
            canary:
              exact: "true"
      route:
        - destination:
            host: codedance
            subset: canary
          weight: 100
    - route:
        - destination:
            host: codedance
            subset: stable
          weight: 90
        - destination:
            host: codedance
            subset: canary
          weight: 10
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: codedance-dr
spec:
  host: codedance
  subsets:
    - name: stable
      labels:
        version: v1
    - name: canary
      labels:
        version: v2
```

#### æ–¹æ¡ˆ B: ä½¿ç”¨ Nginx Ingress + Service

```yaml
apiVersion: v1
kind: Service
metadata:
  name: codedance-stable
spec:
  selector:
    app: codedance
    version: v1
  ports:
    - port: 80
---
apiVersion: v1
kind: Service
metadata:
  name: codedance-canary
spec:
  selector:
    app: codedance
    version: v2
  ports:
    - port: 80
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: codedance-ingress
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"
spec:
  rules:
    - host: codedance.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: codedance-canary
                port:
                  number: 80
```

---

## ä¸‰ã€ä»£ç æ¡†æ¶ç»“æ„

### 3.1 é¡¹ç›®ç›®å½•ç»“æ„

```
codedance/
â”œâ”€â”€ cmd/
â”‚   â”œâ”€â”€ controller/          # æ§åˆ¶å™¨ä¸»ç¨‹åº
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â”œâ”€â”€ api-server/          # API æœåŠ¡
â”‚   â”‚   â””â”€â”€ main.go
â”‚   â””â”€â”€ cli/                 # å‘½ä»¤è¡Œå·¥å…·
â”‚       â””â”€â”€ main.go
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ apis/                # API å®šä¹‰
â”‚   â”‚   â””â”€â”€ deploy/
â”‚   â”‚       â””â”€â”€ v1alpha1/
â”‚   â”‚           â”œâ”€â”€ types.go
â”‚   â”‚           â””â”€â”€ register.go
â”‚   â”œâ”€â”€ controller/          # æ ¸å¿ƒæ§åˆ¶å™¨é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ canary_controller.go
â”‚   â”‚   â”œâ”€â”€ traffic_manager.go
â”‚   â”‚   â”œâ”€â”€ metrics_analyzer.go
â”‚   â”‚   â”œâ”€â”€ decision_engine.go
â”‚   â”‚   â””â”€â”€ rollback_manager.go
â”‚   â”œâ”€â”€ metrics/             # æŒ‡æ ‡æ”¶é›†
â”‚   â”‚   â”œâ”€â”€ prometheus.go
â”‚   â”‚   â”œâ”€â”€ collector.go
â”‚   â”‚   â””â”€â”€ aggregator.go
â”‚   â”œâ”€â”€ traffic/             # æµé‡æ§åˆ¶
â”‚   â”‚   â”œâ”€â”€ istio.go
â”‚   â”‚   â”œâ”€â”€ nginx.go
â”‚   â”‚   â””â”€â”€ interface.go
â”‚   â”œâ”€â”€ strategy/            # å‘å¸ƒç­–ç•¥
â”‚   â”‚   â”œâ”€â”€ linear.go
â”‚   â”‚   â”œâ”€â”€ exponential.go
â”‚   â”‚   â””â”€â”€ manual.go
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ k8s_client.go
â”‚       â””â”€â”€ logger.go
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ crd/                 # CRD å®šä¹‰
â”‚   â”‚   â””â”€â”€ canary_deployment.yaml
â”‚   â”œâ”€â”€ rbac/                # RBAC é…ç½®
â”‚   â”‚   â”œâ”€â”€ role.yaml
â”‚   â”‚   â””â”€â”€ rolebinding.yaml
â”‚   â””â”€â”€ samples/             # ç¤ºä¾‹é…ç½®
â”‚       â””â”€â”€ example_canary.yaml
â”œâ”€â”€ deploy/
â”‚   â”œâ”€â”€ kubernetes/          # K8s éƒ¨ç½²æ¸…å•
â”‚   â”‚   â”œâ”€â”€ controller.yaml
â”‚   â”‚   â”œâ”€â”€ api-server.yaml
â”‚   â”‚   â””â”€â”€ monitoring.yaml
â”‚   â””â”€â”€ helm/                # Helm Charts
â”‚       â””â”€â”€ codedance-deploy/
â”œâ”€â”€ web/                     # å‰ç«¯ç•Œé¢
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â””â”€â”€ api/
â”‚   â””â”€â”€ package.json
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ e2e/
â”‚   â””â”€â”€ integration/
â”œâ”€â”€ docs/
â”‚   â”œâ”€â”€ architecture.md
â”‚   â”œâ”€â”€ api-reference.md
â”‚   â””â”€â”€ user-guide.md
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â”œâ”€â”€ Makefile
â””â”€â”€ README.md
```

### 3.2 æ ¸å¿ƒä»£ç æ¡†æ¶

#### æ§åˆ¶å™¨ä¸»å¾ªç¯

```go
// pkg/controller/canary_controller.go
package controller

import (
    "context"
    "time"
    
    deployv1alpha1 "github.com/codefarmer009/codedance/pkg/apis/deploy/v1alpha1"
    "k8s.io/client-go/kubernetes"
)

type CanaryController struct {
    clientset       *kubernetes.Clientset
    trafficManager  TrafficManager
    metricsAnalyzer MetricsAnalyzer
    decisionEngine  DecisionEngine
    rollbackManager RollbackManager
}

func (c *CanaryController) Run(ctx context.Context) error {
    ticker := time.NewTicker(30 * time.Second)
    defer ticker.Stop()
    
    for {
        select {
        case <-ctx.Done():
            return ctx.Err()
        case <-ticker.C:
            if err := c.reconcile(ctx); err != nil {
                log.Errorf("reconcile failed: %v", err)
            }
        }
    }
}

func (c *CanaryController) reconcile(ctx context.Context) error {
    // 1. è·å–æ‰€æœ‰ CanaryDeployment èµ„æº
    canaries, err := c.listCanaryDeployments(ctx)
    if err != nil {
        return err
    }
    
    // 2. å¤„ç†æ¯ä¸ªç°åº¦å‘å¸ƒ
    for _, canary := range canaries {
        if err := c.processCanary(ctx, canary); err != nil {
            log.Errorf("process canary %s failed: %v", canary.Name, err)
            continue
        }
    }
    
    return nil
}

func (c *CanaryController) processCanary(ctx context.Context, 
    canary *deployv1alpha1.CanaryDeployment) error {
    
    // 1. è·å–å½“å‰çŠ¶æ€
    currentState := canary.Status
    
    // 2. æ”¶é›†æŒ‡æ ‡
    metrics, err := c.metricsAnalyzer.Collect(ctx, canary)
    if err != nil {
        return fmt.Errorf("collect metrics: %w", err)
    }
    
    // 3. å¥åº·æ£€æŸ¥ä¸å†³ç­–
    decision := c.decisionEngine.Evaluate(metrics, canary.Spec.Metrics)
    
    // 4. æ ¹æ®å†³ç­–æ‰§è¡ŒåŠ¨ä½œ
    switch decision.Action {
    case ContinueAction:
        return c.progressToNextStep(ctx, canary)
        
    case PauseAction:
        return c.pauseDeployment(ctx, canary, decision.Reason)
        
    case RollbackAction:
        return c.rollbackManager.Rollback(ctx, canary, decision.Reason)
        
    default:
        return fmt.Errorf("unknown action: %v", decision.Action)
    }
}

func (c *CanaryController) progressToNextStep(ctx context.Context,
    canary *deployv1alpha1.CanaryDeployment) error {
    
    currentStep := canary.Status.CurrentStep
    totalSteps := len(canary.Spec.Strategy.Steps)
    
    if currentStep >= totalSteps-1 {
        // å®Œæˆå‘å¸ƒ
        return c.finalizeDeployment(ctx, canary)
    }
    
    nextStep := currentStep + 1
    weight := canary.Spec.Strategy.Steps[nextStep].Weight
    
    // æ›´æ–°æµé‡æƒé‡
    if err := c.trafficManager.UpdateWeight(ctx, canary, weight); err != nil {
        return fmt.Errorf("update traffic weight: %w", err)
    }
    
    // æ›´æ–°çŠ¶æ€
    canary.Status.CurrentStep = nextStep
    canary.Status.CurrentWeight = weight
    canary.Status.LastUpdateTime = time.Now()
    
    return c.updateStatus(ctx, canary)
}
```

#### æŒ‡æ ‡åˆ†æå™¨

```go
// pkg/metrics/analyzer.go
package metrics

import (
    "context"
    "time"
    
    "github.com/prometheus/client_golang/api"
    v1 "github.com/prometheus/client_golang/api/prometheus/v1"
)

type MetricsAnalyzer struct {
    promClient v1.API
}

func (m *MetricsAnalyzer) Collect(ctx context.Context, 
    canary *CanaryDeployment) (*HealthMetrics, error) {
    
    metrics := &HealthMetrics{}
    
    // 1. æŸ¥è¯¢æˆåŠŸç‡
    successRate, err := m.querySuccessRate(ctx, canary)
    if err != nil {
        return nil, err
    }
    metrics.SuccessRate = successRate
    
    // 2. æŸ¥è¯¢å»¶è¿Ÿ
    latency, err := m.queryLatency(ctx, canary)
    if err != nil {
        return nil, err
    }
    metrics.Latency = latency
    
    // 3. æŸ¥è¯¢é”™è¯¯ç‡
    errorRate, err := m.queryErrorRate(ctx, canary)
    if err != nil {
        return nil, err
    }
    metrics.ErrorRate = errorRate
    
    // 4. æŸ¥è¯¢ Pod å¥åº·çŠ¶æ€
    podHealth, err := m.queryPodHealth(ctx, canary)
    if err != nil {
        return nil, err
    }
    metrics.PodHealth = podHealth
    
    return metrics, nil
}

func (m *MetricsAnalyzer) querySuccessRate(ctx context.Context,
    canary *CanaryDeployment) (float64, error) {
    
    query := canary.Spec.Metrics.SuccessRate.Query
    if query == "" {
        // ä½¿ç”¨é»˜è®¤æŸ¥è¯¢
        query = fmt.Sprintf(`
            sum(rate(http_requests_total{
                app="%s",
                version="%s",
                status=~"2.."
            }[5m])) /
            sum(rate(http_requests_total{
                app="%s",
                version="%s"
            }[5m])) * 100
        `, canary.Name, canary.Spec.CanaryVersion,
           canary.Name, canary.Spec.CanaryVersion)
    }
    
    result, _, err := m.promClient.Query(ctx, query, time.Now())
    if err != nil {
        return 0, err
    }
    
    // è§£æç»“æœ
    return parseFloat(result), nil
}
```

#### æµé‡ç®¡ç†å™¨ï¼ˆIstio å®ç°ï¼‰

```go
// pkg/traffic/istio.go
package traffic

import (
    "context"
    
    networkingv1beta1 "istio.io/api/networking/v1beta1"
    versionedclient "istio.io/client-go/pkg/clientset/versioned"
)

type IstioTrafficManager struct {
    istioClient versionedclient.Interface
}

func (m *IstioTrafficManager) UpdateWeight(ctx context.Context,
    canary *CanaryDeployment, weight int) error {
    
    // è·å– VirtualService
    vs, err := m.istioClient.NetworkingV1beta1().
        VirtualServices(canary.Namespace).
        Get(ctx, canary.Name, metav1.GetOptions{})
    if err != nil {
        return err
    }
    
    // æ›´æ–°æƒé‡
    for i, route := range vs.Spec.Http {
        if len(route.Route) == 2 {
            // stable æƒé‡
            vs.Spec.Http[i].Route[0].Weight = int32(100 - weight)
            // canary æƒé‡
            vs.Spec.Http[i].Route[1].Weight = int32(weight)
        }
    }
    
    // åº”ç”¨æ›´æ–°
    _, err = m.istioClient.NetworkingV1beta1().
        VirtualServices(canary.Namespace).
        Update(ctx, vs, metav1.UpdateOptions{})
    
    return err
}

func (m *IstioTrafficManager) CreateCanaryRoute(ctx context.Context,
    canary *CanaryDeployment) error {
    
    vs := &networkingv1beta1.VirtualService{
        ObjectMeta: metav1.ObjectMeta{
            Name:      canary.Name,
            Namespace: canary.Namespace,
        },
        Spec: networkingv1beta1.VirtualServiceSpec{
            Hosts: []string{canary.Spec.Host},
            Http: []*networkingv1beta1.HTTPRoute{
                {
                    Route: []*networkingv1beta1.HTTPRouteDestination{
                        {
                            Destination: &networkingv1beta1.Destination{
                                Host:   canary.Spec.ServiceName,
                                Subset: "stable",
                            },
                            Weight: 100,
                        },
                        {
                            Destination: &networkingv1beta1.Destination{
                                Host:   canary.Spec.ServiceName,
                                Subset: "canary",
                            },
                            Weight: 0,
                        },
                    },
                },
            },
        },
    }
    
    _, err := m.istioClient.NetworkingV1beta1().
        VirtualServices(canary.Namespace).
        Create(ctx, vs, metav1.CreateOptions{})
    
    return err
}
```

#### å›æ»šç®¡ç†å™¨

```go
// pkg/controller/rollback_manager.go
package controller

import (
    "context"
    "fmt"
    
    appsv1 "k8s.io/api/apps/v1"
    metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

type RollbackManager struct {
    clientset       *kubernetes.Clientset
    trafficManager  TrafficManager
    notifier        Notifier
}

func (r *RollbackManager) Rollback(ctx context.Context,
    canary *CanaryDeployment, reason string) error {
    
    log.Warnf("Rolling back canary %s: %s", canary.Name, reason)
    
    // 1. å°†æµé‡åˆ‡å›ç¨³å®šç‰ˆæœ¬
    if err := r.trafficManager.UpdateWeight(ctx, canary, 0); err != nil {
        return fmt.Errorf("revert traffic: %w", err)
    }
    
    // 2. åˆ é™¤ Canary Pods
    if err := r.deleteCanaryPods(ctx, canary); err != nil {
        return fmt.Errorf("delete canary pods: %w", err)
    }
    
    // 3. æ›´æ–°çŠ¶æ€
    canary.Status.Phase = "Failed"
    canary.Status.Reason = reason
    canary.Status.CurrentWeight = 0
    
    // 4. å‘é€é€šçŸ¥
    r.notifier.SendAlert(AlertMessage{
        Level:   "error",
        Title:   fmt.Sprintf("Canary %s rolled back", canary.Name),
        Message: reason,
    })
    
    return nil
}

func (r *RollbackManager) deleteCanaryPods(ctx context.Context,
    canary *CanaryDeployment) error {
    
    // ç¼©å®¹ Canary Deployment åˆ° 0
    deployment, err := r.clientset.AppsV1().
        Deployments(canary.Namespace).
        Get(ctx, canary.Spec.TargetDeployment+"-canary", metav1.GetOptions{})
    if err != nil {
        return err
    }
    
    replicas := int32(0)
    deployment.Spec.Replicas = &replicas
    
    _, err = r.clientset.AppsV1().
        Deployments(canary.Namespace).
        Update(ctx, deployment, metav1.UpdateOptions{})
    
    return err
}
```

---

## å››ã€å®æ–½æ­¥éª¤

### é˜¶æ®µ 1: åŸºç¡€è®¾æ–½æ­å»º (Week 1-2)

**ä»»åŠ¡æ¸…å•:**
- [ ] æ­å»º Kubernetes é›†ç¾¤ï¼ˆæˆ–ä½¿ç”¨ç°æœ‰é›†ç¾¤ï¼‰
- [ ] éƒ¨ç½² Istio æˆ–é…ç½® Nginx Ingress
- [ ] éƒ¨ç½² Prometheus + Grafana
- [ ] é…ç½® ELK æˆ– Loki æ—¥å¿—ç³»ç»Ÿ
- [ ] åˆ›å»ºé¡¹ç›®åŸºç¡€ä»£ç ç»“æ„

**å…³é”®äº§å‡º:**
- K8s é›†ç¾¤å¯è®¿é—®
- ç›‘æ§ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
- åŸºç¡€é¡¹ç›®æ¡†æ¶æ­å»ºå®Œæˆ

### é˜¶æ®µ 2: CRD å’Œæ§åˆ¶å™¨å¼€å‘ (Week 3-4)

**ä»»åŠ¡æ¸…å•:**
- [ ] å®šä¹‰ `CanaryDeployment` CRD
- [ ] ç”Ÿæˆ CRD å®¢æˆ·ç«¯ä»£ç ï¼ˆä½¿ç”¨ code-generatorï¼‰
- [ ] å®ç°æ§åˆ¶å™¨ä¸»å¾ªç¯
- [ ] å®ç°çŠ¶æ€åŒæ­¥é€»è¾‘
- [ ] ç¼–å†™å•å…ƒæµ‹è¯•

**å…³é”®ä»£ç :**
```bash
# ç”Ÿæˆ CRD å®¢æˆ·ç«¯ä»£ç 
go get k8s.io/code-generator
./hack/update-codegen.sh

# å®‰è£… CRD
kubectl apply -f config/crd/canary_deployment.yaml

# è¿è¡Œæ§åˆ¶å™¨
go run cmd/controller/main.go
```

### é˜¶æ®µ 3: æµé‡ç®¡ç†å®ç° (Week 5)

**ä»»åŠ¡æ¸…å•:**
- [ ] å®ç° Istio æµé‡ç®¡ç†å™¨
- [ ] å®ç° Nginx Ingress æµé‡ç®¡ç†å™¨ï¼ˆå¤‡é€‰ï¼‰
- [ ] å®ç°æµé‡æƒé‡åŠ¨æ€è°ƒæ•´
- [ ] æµ‹è¯•æµé‡åˆ†å‘å‡†ç¡®æ€§

**æµ‹è¯•æ–¹æ³•:**
```bash
# å‘é€æµ‹è¯•æµé‡ï¼ŒéªŒè¯åˆ†å‘æ¯”ä¾‹
for i in {1..1000}; do
  curl -s http://codedance.example.com/api/version | grep version
done | sort | uniq -c
```

### é˜¶æ®µ 4: æŒ‡æ ‡æ”¶é›†ä¸åˆ†æ (Week 6)

**ä»»åŠ¡æ¸…å•:**
- [ ] é›†æˆ Prometheus å®¢æˆ·ç«¯
- [ ] å®ç°æŒ‡æ ‡æŸ¥è¯¢æ¥å£
- [ ] å®ç°æŒ‡æ ‡èšåˆä¸è®¡ç®—
- [ ] é…ç½® Grafana Dashboard
- [ ] æµ‹è¯•æŒ‡æ ‡å‡†ç¡®æ€§

**Grafana Dashboard é…ç½®:**
- åˆ›å»ºç°åº¦å‘å¸ƒç›‘æ§é¢æ¿
- æ˜¾ç¤ºå®æ—¶æµé‡åˆ†å¸ƒ
- æ˜¾ç¤ºå…³é”®å¥åº·æŒ‡æ ‡
- é…ç½®å‘Šè­¦è§„åˆ™

### é˜¶æ®µ 5: å†³ç­–å¼•æ“å¼€å‘ (Week 7)

**ä»»åŠ¡æ¸…å•:**
- [ ] å®ç°å¥åº·è¯„åˆ†ç®—æ³•
- [ ] å®ç°é˜ˆå€¼æ£€æŸ¥é€»è¾‘
- [ ] å®ç°å†³ç­–è§„åˆ™å¼•æ“
- [ ] æ·»åŠ å¯é…ç½®çš„å†³ç­–ç­–ç•¥
- [ ] ç¼–å†™å†³ç­–æµ‹è¯•ç”¨ä¾‹

**æµ‹è¯•åœºæ™¯:**
- æ­£å¸¸æŒ‡æ ‡ â†’ ç»§ç»­å‘å¸ƒ
- è½»å¾®å¼‚å¸¸ â†’ æš‚åœè§‚å¯Ÿ
- ä¸¥é‡å¼‚å¸¸ â†’ è‡ªåŠ¨å›æ»š

### é˜¶æ®µ 6: å›æ»šæœºåˆ¶å®ç° (Week 8)

**ä»»åŠ¡æ¸…å•:**
- [ ] å®ç°è‡ªåŠ¨å›æ»šé€»è¾‘
- [ ] å®ç°æ‰‹åŠ¨å›æ»šæ¥å£
- [ ] ä¿å­˜å‘å¸ƒå†å²å¿«ç…§
- [ ] å®ç°å›æ»šçŠ¶æ€è¿½è¸ª
- [ ] æµ‹è¯•å›æ»šå¯é æ€§

**å›æ»šè§¦å‘æ¡ä»¶:**
- æˆåŠŸç‡ < é˜ˆå€¼
- é”™è¯¯ç‡ > é˜ˆå€¼
- Pod å´©æºƒç‡è¿‡é«˜
- æ‰‹åŠ¨è§¦å‘

### é˜¶æ®µ 7: å‘å¸ƒç­–ç•¥å®ç° (Week 9)

**ä»»åŠ¡æ¸…å•:**
- [ ] å®ç°çº¿æ€§é€’å¢ç­–ç•¥
- [ ] å®ç°æŒ‡æ•°é€’å¢ç­–ç•¥
- [ ] å®ç°æ‰‹åŠ¨æ§åˆ¶ç­–ç•¥
- [ ] æ”¯æŒè‡ªå®šä¹‰ç­–ç•¥é…ç½®
- [ ] æµ‹è¯•å„ç§ç­–ç•¥

### é˜¶æ®µ 8: API å’Œ CLI å¼€å‘ (Week 10)

**ä»»åŠ¡æ¸…å•:**
- [ ] è®¾è®¡ RESTful API
- [ ] å®ç°å‘å¸ƒç®¡ç†æ¥å£
- [ ] å®ç°çŠ¶æ€æŸ¥è¯¢æ¥å£
- [ ] å¼€å‘ CLI å·¥å…·
- [ ] ç¼–å†™ API æ–‡æ¡£

**CLI å‘½ä»¤ç¤ºä¾‹:**
```bash
# åˆ›å»ºç°åº¦å‘å¸ƒ
codedance-cli deploy create \
  --name myapp \
  --version v2.0.0 \
  --strategy linear \
  --auto-rollback

# æŸ¥çœ‹å‘å¸ƒçŠ¶æ€
codedance-cli deploy status myapp

# æ‰‹åŠ¨æš‚åœ
codedance-cli deploy pause myapp

# æ‰‹åŠ¨ç»§ç»­
codedance-cli deploy resume myapp

# æ‰‹åŠ¨å›æ»š
codedance-cli deploy rollback myapp
```

### é˜¶æ®µ 9: Web ç•Œé¢å¼€å‘ (Week 11-12)

**ä»»åŠ¡æ¸…å•:**
- [ ] è®¾è®¡ UI/UX
- [ ] å®ç°å‘å¸ƒåˆ›å»ºé¡µé¢
- [ ] å®ç°å®æ—¶ç›‘æ§é¢æ¿
- [ ] å®ç°å‘å¸ƒå†å²æŸ¥çœ‹
- [ ] å®ç°æ‰‹åŠ¨æ§åˆ¶ç•Œé¢

**ç•Œé¢åŠŸèƒ½:**
- åˆ›å»ºæ–°çš„ç°åº¦å‘å¸ƒ
- å®æ—¶æŸ¥çœ‹å‘å¸ƒè¿›åº¦
- æŸ¥çœ‹å…³é”®æŒ‡æ ‡å›¾è¡¨
- æ‰‹åŠ¨æ§åˆ¶å‘å¸ƒæµç¨‹
- æŸ¥çœ‹å†å²å‘å¸ƒè®°å½•

### é˜¶æ®µ 10: é›†æˆæµ‹è¯•ä¸ä¼˜åŒ– (Week 13-14)

**ä»»åŠ¡æ¸…å•:**
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] å‹åŠ›æµ‹è¯•
- [ ] æ•…éšœæ³¨å…¥æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] å®‰å…¨åŠ å›º

**æµ‹è¯•åœºæ™¯:**
```yaml
# æµ‹è¯•ç”¨ä¾‹ 1: æ­£å¸¸å‘å¸ƒæµç¨‹
- å¯åŠ¨ç°åº¦å‘å¸ƒ
- éªŒè¯æµé‡é€æ­¥åˆ‡æ¢
- éªŒè¯æŒ‡æ ‡æ­£å¸¸
- å®Œæˆå‘å¸ƒ

# æµ‹è¯•ç”¨ä¾‹ 2: è‡ªåŠ¨å›æ»š
- å¯åŠ¨ç°åº¦å‘å¸ƒ
- æ³¨å…¥é”™è¯¯ï¼ˆè¿”å› 500ï¼‰
- éªŒè¯è‡ªåŠ¨æ£€æµ‹å¼‚å¸¸
- éªŒè¯è‡ªåŠ¨å›æ»š

# æµ‹è¯•ç”¨ä¾‹ 3: æ‰‹åŠ¨æ§åˆ¶
- å¯åŠ¨æ‰‹åŠ¨ç­–ç•¥å‘å¸ƒ
- æ‰‹åŠ¨è°ƒæ•´æµé‡æƒé‡
- æ‰‹åŠ¨æš‚åœ/ç»§ç»­
- æ‰‹åŠ¨å›æ»š
```

---

## äº”ã€é…ç½®ç¤ºä¾‹

### 5.1 ç°åº¦å‘å¸ƒé…ç½®ç¤ºä¾‹

```yaml
apiVersion: deploy.codedance.io/v1alpha1
kind: CanaryDeployment
metadata:
  name: codedance-app
  namespace: production
spec:
  # ç›®æ ‡ Deployment
  targetDeployment: codedance
  
  # ç°åº¦ç‰ˆæœ¬é•œåƒ
  canaryVersion: codedance:v2.0.0
  
  # å‘å¸ƒç­–ç•¥
  strategy:
    type: Linear
    steps:
      - weight: 5
        pause: 5m
      - weight: 10
        pause: 5m
      - weight: 25
        pause: 10m
      - weight: 50
        pause: 10m
      - weight: 75
        pause: 10m
      - weight: 100
        pause: 0
  
  # ç›‘æ§æŒ‡æ ‡é˜ˆå€¼
  metrics:
    successRate:
      threshold: 99.5
      query: |
        sum(rate(http_requests_total{app="codedance",status=~"2.."}[5m])) /
        sum(rate(http_requests_total{app="codedance"}[5m])) * 100
    
    latency:
      p99: 500ms
      query: |
        histogram_quantile(0.99,
          sum(rate(http_request_duration_seconds_bucket{app="codedance"}[5m])) by (le))
    
    errorRate:
      threshold: 0.5
      query: |
        sum(rate(http_requests_total{app="codedance",status=~"5.."}[5m])) /
        sum(rate(http_requests_total{app="codedance"}[5m])) * 100
  
  # è‡ªåŠ¨å›æ»šé…ç½®
  autoRollback:
    enabled: true
    onMetricsFail: true
    onPodCrash: true
```

### 5.2 åº”ç”¨éƒ¨ç½²ç¤ºä¾‹

```yaml
---
# Stable Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: codedance-stable
spec:
  replicas: 5
  selector:
    matchLabels:
      app: codedance
      version: v1
  template:
    metadata:
      labels:
        app: codedance
        version: v1
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: app
          image: codedance:v1.0.0
          ports:
            - containerPort: 8080
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 3
---
# Canary Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: codedance-canary
spec:
  replicas: 1
  selector:
    matchLabels:
      app: codedance
      version: v2
  template:
    metadata:
      labels:
        app: codedance
        version: v2
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: app
          image: codedance:v2.0.0
          ports:
            - containerPort: 8080
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 5
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 3
```

---

## å…­ã€å…³é”®æŠ€æœ¯è¦ç‚¹

### 6.1 é«˜å¯ç”¨è®¾è®¡

- **æ§åˆ¶å™¨é«˜å¯ç”¨**: ä½¿ç”¨ Leader Electionï¼Œå¤šå‰¯æœ¬éƒ¨ç½²
- **æ•°æ®æŒä¹…åŒ–**: çŠ¶æ€å­˜å‚¨åœ¨ etcdï¼ˆK8s åŸç”Ÿæ”¯æŒï¼‰
- **ä¼˜é›…é™çº§**: ç›‘æ§ç³»ç»Ÿæ•…éšœæ—¶ï¼Œæš‚åœè‡ªåŠ¨å†³ç­–

### 6.2 å®‰å…¨è€ƒè™‘

- **RBAC æƒé™æ§åˆ¶**: æœ€å°æƒé™åŸåˆ™
- **å®¡è®¡æ—¥å¿—**: è®°å½•æ‰€æœ‰å‘å¸ƒæ“ä½œ
- **å¯†é’¥ç®¡ç†**: ä½¿ç”¨ K8s Secrets
- **ç½‘ç»œéš”ç¦»**: ä½¿ç”¨ NetworkPolicy

### 6.3 æ€§èƒ½ä¼˜åŒ–

- **æŒ‡æ ‡ç¼“å­˜**: é¿å…é¢‘ç¹æŸ¥è¯¢ Prometheus
- **æ‰¹é‡æ“ä½œ**: æ‰¹é‡æ›´æ–° K8s èµ„æº
- **å¼‚æ­¥å¤„ç†**: é•¿æ—¶é—´æ“ä½œä½¿ç”¨å¼‚æ­¥æ¨¡å¼
- **èµ„æºé™åˆ¶**: è®¾ç½® CPU/Memory limits

### 6.4 å¯è§‚æµ‹æ€§

- **ç»“æ„åŒ–æ—¥å¿—**: ä½¿ç”¨ç»Ÿä¸€çš„æ—¥å¿—æ ¼å¼
- **åˆ†å¸ƒå¼è¿½è¸ª**: é›†æˆ Jaeger
- **æŒ‡æ ‡æš´éœ²**: æ§åˆ¶å™¨è‡ªèº«æš´éœ² Prometheus æŒ‡æ ‡
- **å‘Šè­¦é€šçŸ¥**: é›†æˆ Slack/é’‰é’‰/é‚®ä»¶

---

## ä¸ƒã€åç»­æ‰©å±•æ–¹å‘

1. **å¤šé›†ç¾¤æ”¯æŒ**: è·¨å¤šä¸ª K8s é›†ç¾¤è¿›è¡Œç°åº¦å‘å¸ƒ
2. **AI å†³ç­–**: ä½¿ç”¨æœºå™¨å­¦ä¹ ä¼˜åŒ–å†³ç­–ç®—æ³•
3. **æµé‡å½•åˆ¶å›æ”¾**: ç”¨äºæµ‹è¯•ç¯å¢ƒéªŒè¯
4. **æˆæœ¬ä¼˜åŒ–**: è‡ªåŠ¨è°ƒæ•´èµ„æºé…é¢
5. **GitOps é›†æˆ**: ä¸ ArgoCD/FluxCD é›†æˆ
6. **æ··æ²Œå·¥ç¨‹**: å†…ç½®æ•…éšœæ³¨å…¥èƒ½åŠ›
7. **å¤šç§Ÿæˆ·æ”¯æŒ**: æ”¯æŒå¤šå›¢é˜Ÿéš”ç¦»ä½¿ç”¨

---

## å…«ã€å‚è€ƒèµ„æº

- **Kubernetes å®˜æ–¹æ–‡æ¡£**: https://kubernetes.io/docs/
- **Istio å®˜æ–¹æ–‡æ¡£**: https://istio.io/latest/docs/
- **Prometheus æ–‡æ¡£**: https://prometheus.io/docs/
- **Flagger (ç°åº¦å‘å¸ƒå¼€æºé¡¹ç›®)**: https://github.com/fluxcd/flagger
- **Argo Rollouts**: https://argoproj.github.io/rollouts/

---

ä»¥ä¸Šæ˜¯å®Œæ•´çš„æ¶æ„è®¾è®¡å’Œå®æ–½æ–¹æ¡ˆã€‚å»ºè®®æ‚¨å…ˆä»é˜¶æ®µ 1 å¼€å§‹ï¼Œé€æ­¥å®ç°å„ä¸ªç»„ä»¶ã€‚å¦‚æœæ‚¨æœ‰ä»»ä½•å…·ä½“çš„æŠ€æœ¯é—®é¢˜æˆ–éœ€è¦æŸä¸ªæ¨¡å—çš„è¯¦ç»†å®ç°ï¼Œè¯·éšæ—¶å‘Šè¯‰æˆ‘ï¼

---

**@codefarmer009** (Oct 24, 05:02)
@xgopilot è¯·æ ¹æ®ä¸Šé¢ç”Ÿæˆçš„åŸºæœ¬ä»£ç ç»“æ„å’Œå®ç°åœ¨æœ¬æ¬¡pull requestä¸­æ·»åŠ å¯¹åº”çš„ç›®å½•å’Œä»£ç æ–‡ä»¶ï¼Œä»¥åŠåœ¨prä¸­ç”Ÿæˆå¯¹åº”çš„é…ç½®æ–‡ä»¶

---

**@xgopilot** (Oct 24, 05:02)
### âœ… K8s æ™ºèƒ½å‘å¸ƒç³»ç»Ÿå®ç°å®Œæˆ

å·²æˆåŠŸåˆ›å»ºåŸºäº Kubernetes çš„æ™ºèƒ½å‘å¸ƒç³»ç»Ÿçš„å®Œæ•´ä»£ç æ¡†æ¶å’Œé…ç½®æ–‡ä»¶ã€‚

## ğŸ“¦ å·²åˆ›å»ºçš„å†…å®¹

### æ ¸å¿ƒä»£ç å®ç°

#### 1. CRD å®šä¹‰ (`pkg/apis/deploy/v1alpha1/`)
- `types.go` - CanaryDeployment CRD ç±»å‹å®šä¹‰
- `register.go` - API æ³¨å†Œå’Œ Scheme é…ç½®

#### 2. æ§åˆ¶å™¨ç»„ä»¶ (`pkg/controller/`)
- `canary_controller.go` - æ ¸å¿ƒæ§åˆ¶å™¨ï¼ŒåŒ…å«ä¸»å¾ªç¯å’Œåè°ƒé€»è¾‘
- `decision_engine.go` - æ™ºèƒ½å†³ç­–å¼•æ“ï¼ŒåŸºäºæŒ‡æ ‡è¿›è¡Œå¥åº·è¯„åˆ†
- `rollback_manager.go` - å›æ»šç®¡ç†å™¨ï¼Œå¤„ç†è‡ªåŠ¨å’Œæ‰‹åŠ¨å›æ»š
- `interfaces.go` - æ¥å£å®šä¹‰ï¼Œæ”¯æŒæ‰©å±•æ€§

#### 3. æŒ‡æ ‡åˆ†æ (`pkg/metrics/`)
- `analyzer.go` - Prometheus æŒ‡æ ‡æ”¶é›†å™¨ï¼Œæ”¯æŒè‡ªå®šä¹‰ PromQL æŸ¥è¯¢

#### 4. æµé‡ç®¡ç† (`pkg/traffic/`)
- `istio.go` - Istio VirtualService æµé‡ç®¡ç†å®ç°
- `nginx.go` - Nginx Ingress Canary æµé‡ç®¡ç†å®ç°

#### 5. å‘å¸ƒç­–ç•¥ (`pkg/strategy/`)
- `linear.go` - çº¿æ€§é€’å¢ç­–ç•¥ (5%â†’10%â†’25%â†’50%â†’75%â†’100%)
- `exponential.go` - æŒ‡æ•°é€’å¢ç­–ç•¥ (1%â†’5%â†’10%â†’25%â†’50%â†’100%)

#### 6. ä¸»ç¨‹åºå…¥å£ (`cmd/controller/`)
- `main.go` - æ§åˆ¶å™¨å¯åŠ¨ç¨‹åºï¼Œæ”¯æŒå‘½ä»¤è¡Œå‚æ•°é…ç½®

### Kubernetes é…ç½®æ–‡ä»¶

#### 1. CRD å®šä¹‰ (`config/crd/`)
- `canary_deployment.yaml` - å®Œæ•´çš„ CRD å®šä¹‰ï¼ŒåŒ…å« schema éªŒè¯

#### 2. RBAC é…ç½® (`config/rbac/`)
- `role.yaml` - ClusterRole æƒé™å®šä¹‰
- `rolebinding.yaml` - ServiceAccount å’Œæƒé™ç»‘å®š

#### 3. ç¤ºä¾‹é…ç½® (`config/samples/`)
- `example_canary.yaml` - ç°åº¦å‘å¸ƒé…ç½®ç¤ºä¾‹
- `deployment_example.yaml` - åº”ç”¨éƒ¨ç½²ç¤ºä¾‹ï¼ˆStable + Canaryï¼‰

#### 4. éƒ¨ç½²æ¸…å• (`deploy/kubernetes/`)
- `controller.yaml` - æ§åˆ¶å™¨ Deployment é…ç½®

### é¡¹ç›®é…ç½®æ–‡ä»¶

- `go.mod` - Go æ¨¡å—ä¾èµ–ç®¡ç†
- `Makefile` - æ„å»ºå’Œéƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬
- `Dockerfile` - å¤šé˜¶æ®µæ„å»ºçš„ Docker é•œåƒ
- `.gitignore` - Git å¿½ç•¥è§„åˆ™

### æ–‡æ¡£

#### å®Œæ•´æ–‡æ¡£é›† (`docs/`)
1. **æ¶æ„æ–‡æ¡£** (`architecture.md`)
   - ç³»ç»Ÿæ¦‚è¿°å’Œæ ¸å¿ƒç»„ä»¶
   - å‘å¸ƒæµç¨‹è¯´æ˜
   - ç°åº¦ç­–ç•¥è¯¦è§£
   - éƒ¨ç½²æ¶æ„å›¾
   - å®‰å…¨å’Œæ‰©å±•æ€§è€ƒè™‘

2. **å¿«é€Ÿå¼€å§‹** (`getting-started.md`)
   - å‰ç½®æ¡ä»¶å’Œå®‰è£…æ­¥éª¤
   - åˆ›å»ºç¬¬ä¸€ä¸ªç°åº¦å‘å¸ƒ
   - æœ¬åœ°å¼€å‘æŒ‡å—
   - ç›‘æ§å’Œè°ƒè¯•æ–¹æ³•
   - å¸¸è§é—®é¢˜è§£ç­”

3. **API å‚è€ƒ** (`api-reference.md`)
   - CRD å®Œæ•´å­—æ®µè¯´æ˜
   - Spec å’Œ Status è¯¦è§£
   - å®Œæ•´é…ç½®ç¤ºä¾‹
   - kubectl å‘½ä»¤å‚è€ƒ

#### æ›´æ–°çš„ README
- é¡¹ç›®å®šä½ä¸º K8s æ™ºèƒ½å‘å¸ƒç³»ç»Ÿ
- æ ¸å¿ƒç‰¹æ€§è¯´æ˜
- å¿«é€Ÿå¼€å§‹æŒ‡å—
- å®Œæ•´é¡¹ç›®ç»“æ„
- å¼€å‘æŒ‡å—å’Œæ¶æ„å›¾
- å¼€å‘è·¯çº¿å›¾

## ğŸ¯ ç³»ç»Ÿç‰¹æ€§

### ç°åº¦å‘å¸ƒç­–ç•¥
âœ… **çº¿æ€§é€’å¢**: 5% â†’ 10% â†’ 25% â†’ 50% â†’ 75% â†’ 100%  
âœ… **æŒ‡æ•°é€’å¢**: 1% â†’ 5% â†’ 10% â†’ 25% â†’ 50% â†’ 100%  
âœ… **æ‰‹åŠ¨æ§åˆ¶**: ç”¨æˆ·æ‰‹åŠ¨æ§åˆ¶æ¯ä¸ªé˜¶æ®µ

### ç›‘æ§ä¸å†³ç­–
âœ… **æˆåŠŸç‡ç›‘æ§**: HTTP 2xx å“åº”å æ¯”  
âœ… **å»¶è¿Ÿåˆ†æ**: P50/P90/P99 å»¶è¿ŸæŒ‡æ ‡  
âœ… **é”™è¯¯ç‡è¿½è¸ª**: HTTP 5xx é”™è¯¯ç‡  
âœ… **Pod å¥åº·æ£€æŸ¥**: è‡ªåŠ¨æ£€æµ‹ Pod çŠ¶æ€  
âœ… **æ™ºèƒ½å†³ç­–**: å¤šç»´åº¦æŒ‡æ ‡å¥åº·è¯„åˆ†

### æµé‡ç®¡ç†
âœ… **Istio æ”¯æŒ**: VirtualService + DestinationRule  
âœ… **Nginx Ingress**: Canary Annotations  
âœ… **åŠ¨æ€æƒé‡è°ƒæ•´**: å¹³æ»‘æµé‡åˆ‡æ¢

### è‡ªåŠ¨å›æ»š
âœ… **æŒ‡æ ‡å¼‚å¸¸æ£€æµ‹**: æˆåŠŸç‡/å»¶è¿Ÿ/é”™è¯¯ç‡è¶…é˜ˆå€¼è‡ªåŠ¨å›æ»š  
âœ… **Pod å´©æºƒæ£€æµ‹**: Pod å¼‚å¸¸è‡ªåŠ¨å›æ»š  
âœ… **æ‰‹åŠ¨å›æ»š**: æ”¯æŒç”¨æˆ·æ‰‹åŠ¨è§¦å‘

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### å®‰è£…ç³»ç»Ÿ
```bash
kubectl apply -f config/crd/canary_deployment.yaml
kubectl apply -f config/rbac/
kubectl apply -f deploy/kubernetes/controller.yaml
```

### åˆ›å»ºç°åº¦å‘å¸ƒ
```bash
kubectl apply -f config/samples/deployment_example.yaml
kubectl apply -f config/samples/example_canary.yaml
```

### æŸ¥çœ‹çŠ¶æ€
```bash
kubectl get canarydeployment -n production
kubectl describe canarydeployment codedance-app -n production
```

## ğŸ“‚ é¡¹ç›®ç»“æ„
```
codedance/
â”œâ”€â”€ cmd/controller/          âœ… æ§åˆ¶å™¨ä¸»ç¨‹åº
â”œâ”€â”€ pkg/
â”‚   â”œâ”€â”€ apis/deploy/v1alpha1/ âœ… CRD ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ controller/          âœ… æ§åˆ¶å™¨é€»è¾‘
â”‚   â”œâ”€â”€ metrics/             âœ… æŒ‡æ ‡æ”¶é›†
â”‚   â”œâ”€â”€ traffic/             âœ… æµé‡ç®¡ç†
â”‚   â””â”€â”€ strategy/            âœ… å‘å¸ƒç­–ç•¥
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ crd/                 âœ… CRD å®šä¹‰
â”‚   â”œâ”€â”€ rbac/                âœ… RBAC é…ç½®
â”‚   â””â”€â”€ samples/             âœ… ç¤ºä¾‹é…ç½®
â”œâ”€â”€ deploy/kubernetes/       âœ… K8s éƒ¨ç½²æ¸…å•
â”œâ”€â”€ docs/                    âœ… å®Œæ•´æ–‡æ¡£
â”œâ”€â”€ Dockerfile               âœ… Docker é•œåƒ
â”œâ”€â”€ Makefile                 âœ… æ„å»ºè„šæœ¬
â””â”€â”€ go.mod                   âœ… Go æ¨¡å—
```

## ğŸ”§ æ„å»ºå’Œéƒ¨ç½²

```bash
# æ„å»º
make build

# æ„å»º Docker é•œåƒ
make docker-build VERSION=v1.0.0

# éƒ¨ç½²åˆ°é›†ç¾¤
make deploy

# æœ¬åœ°è¿è¡Œ
make controller
```

## ğŸ“– æ–‡æ¡£é“¾æ¥

- [å¿«é€Ÿå¼€å§‹æŒ‡å—](docs/getting-started.md) - å®‰è£…å’Œä½¿ç”¨è¯´æ˜
- [æ¶æ„è®¾è®¡æ–‡æ¡£](docs/architecture.md) - ç³»ç»Ÿè®¾è®¡è¯¦è§£
- [API å‚è€ƒæ–‡æ¡£](docs/api-reference.md) - CRD é…ç½®å‚è€ƒ

## âœ¨ åç»­å»ºè®®

è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„åŸºç¡€æ¡†æ¶ï¼Œå»ºè®®æŒ‰ä»¥ä¸‹é¡ºåºå®Œå–„ï¼š

1. **å®Œå–„ä¾èµ–ç®¡ç†**: è¿è¡Œ `go mod tidy` è¡¥å…¨ä¾èµ–
2. **æ·»åŠ å•å…ƒæµ‹è¯•**: ä¸ºæ ¸å¿ƒç»„ä»¶æ·»åŠ æµ‹è¯•ç”¨ä¾‹
3. **å®ç° Helm Chart**: ç®€åŒ–éƒ¨ç½²æµç¨‹
4. **å¼€å‘ CLI å·¥å…·**: æä¾›å‘½ä»¤è¡Œæ“ä½œç•Œé¢
5. **æ„å»º Web UI**: å¯è§†åŒ–å‘å¸ƒç®¡ç†ç•Œé¢
6. **é›†æˆ CI/CD**: è‡ªåŠ¨åŒ–æ„å»ºå’Œæµ‹è¯•æµç¨‹

æ‰€æœ‰ä»£ç å·²æäº¤åˆ°åˆ†æ”¯ `xgopilot/claude/issue-2-1761281463` å¹¶æ¨é€åˆ°è¿œç¨‹ä»“åº“ã€‚

---

**@codefarmer009** (Oct 26, 06:03)
@xgopilot è¯·å¯¹è¿™ä¸ªprä¸­ç”Ÿæˆçš„æ–‡ä»¶ä¸­çš„ä»£ç ç»§ç»­ä¼˜åŒ–å®Œå–„

---

**@xgopilot** (Oct 26, 06:03)
codeagent is processing your request, please wait a moment...

---

