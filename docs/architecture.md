# Codedance 智能发布系统架构文档

## 系统概述

Codedance 是一个基于 Kubernetes 的智能发布系统，支持灰度发布、实时监控、自动暂停和回滚功能。

## 核心组件

### 1. 发布控制器 (Canary Controller)
- 负责管理整个灰度发布生命周期
- 监听 CanaryDeployment CRD 资源变化
- 协调各个子组件完成发布任务

### 2. 指标分析器 (Metrics Analyzer)
- 从 Prometheus 收集应用指标
- 支持自定义 PromQL 查询
- 计算成功率、延迟、错误率等关键指标

### 3. 决策引擎 (Decision Engine)
- 基于指标阈值进行健康评分
- 自动决策是否继续、暂停或回滚
- 支持自定义决策规则

### 4. 流量管理器 (Traffic Manager)
- 支持 Istio VirtualService
- 支持 Nginx Ingress Canary
- 动态调整流量权重

### 5. 回滚管理器 (Rollback Manager)
- 自动检测异常并触发回滚
- 恢复稳定版本流量
- 清理 Canary 资源

## 发布流程

1. 用户创建 CanaryDeployment 资源
2. 控制器检测到新资源，开始灰度发布
3. 按照策略逐步增加 Canary 流量权重
4. 每个阶段收集指标并进行健康检查
5. 根据决策结果继续、暂停或回滚
6. 完成发布或回滚到稳定版本

## 灰度策略

### Linear (线性递增)
5% → 10% → 25% → 50% → 75% → 100%

### Exponential (指数递增)
1% → 5% → 10% → 25% → 50% → 100%

### Manual (手动控制)
用户手动触发每个阶段

## 监控指标

- **成功率**: HTTP 2xx 响应占比
- **延迟**: P50/P90/P99 延迟
- **错误率**: HTTP 5xx 响应占比
- **Pod 健康**: Ready/NotReady/Failed 数量
- **资源使用**: CPU/Memory 使用率

## 部署架构

```
┌─────────────────────────────────────────┐
│         Kubernetes Cluster               │
├─────────────────────────────────────────┤
│  ┌──────────────────────────────────┐  │
│  │   Codedance Controller           │  │
│  │   - Canary Controller            │  │
│  │   - Metrics Analyzer             │  │
│  │   - Decision Engine              │  │
│  │   - Traffic Manager              │  │
│  │   - Rollback Manager             │  │
│  └──────────────────────────────────┘  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │   Istio / Nginx Ingress          │  │
│  └──────────────────────────────────┘  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │   Application Pods               │  │
│  │   - Stable Pods (v1)             │  │
│  │   - Canary Pods (v2)             │  │
│  └──────────────────────────────────┘  │
│                                          │
│  ┌──────────────────────────────────┐  │
│  │   Prometheus + Grafana           │  │
│  └──────────────────────────────────┘  │
└─────────────────────────────────────────┘
```

## 安全考虑

- RBAC 权限控制
- 审计日志记录
- 密钥管理使用 K8s Secrets
- 网络隔离使用 NetworkPolicy

## 扩展性

系统设计遵循接口导向原则，易于扩展：

- 支持添加新的流量管理器
- 支持自定义决策引擎
- 支持集成其他监控系统
- 支持添加新的发布策略
